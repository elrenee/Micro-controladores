; Prelab 01.asm
; Created: 2/02/2025 16:12:04
; Author : RENÉ GONZÁLEZ, 23365
;
.include "M328PDEF.inc"

.cseg //lo que sigue es codigo
.org 0x0000
// coonfigurams la pila
LDI R16, LOW(RAMEND)
OUT SPL, R16
LDI R16, HIGH(RAMEND)
OUT SPH, R16
//configuramos el MCU
SETUP:
	//Seteamos los pines de entrada y salida
	LDI R16, 0x00
	OUT DDRD, R16  //Seteamos el puerto D como entrada 
	LDI R16, 0Xff
	OUT PORTD, R16 //HABLITAMOS PULL-UP
	
	OUT DDRB, R16//SETEAMOS EL PUERTO B COMO SALIDA
	LDI R16, 0X00
	OUT PORTB, R16// CONFIGURAMOS 0V EN CADA PIN DEL PUERTO B


	LDI		R18,0X00 //CONTADOR UNO A 0
	LDI		R17, 0x00 //Contador DOS A 0
	LDI		R19, 0XFF // ESTADO ACTUAL 
	LDI		R20, 0x00// Salida contador 1 y 2

Loop:
	IN		R16, PIND
	CP 		R19, R16
	BREQ	Loop
	MOV		R19, R16
	SBIS	PIND, 0
	CALL	MAIN
	SBIS	PIND, 1
	CALL	MAIN2
	SBIS	PIND, 2
	CALL	MAIN3
	SBIS	PIND, 3
	CALL	MAIN4
	DEFAULT:
		JMP Loop

Main:
	CALL	TIEMPO
	IN		R16, PIND
	SBIS	PIND, 0
	CALL	SUMAR
	RET

Main2:
	CALL	TIEMPO
	IN		R16, PIND
	SBIS	PIND, 1
	CALL	RESTAR
	RET

MAIN3:
	CALL	TIEMPO
	IN		R16, PIND
	SBIS	PIND, 2
	CALL	SUMAR2
	RET

MAIN4:
	CALL	TIEMPO
	IN		R16, PIND
	SBIS	PIND, 3
	CALL	RESTAR2
	RET


SUMAR:
		SBRS	R16, 0
		INC		R18
		CALL	evitar_carry
		ADD		R20, R18
		OUT		PORTB, R20
		RET
evitar_carry:
		CPI		R18, 0x10
		BREQ	LIMPIAR
		RET
LIMPIAR:
		CLR		R18
		RET



RESTAR:
		SBRS	R16, 1
		DEC		R18
		CALL	Evitar_underflow
		ADD		R20, R18
		OUT		PORTB, R20
		RET
Evitar_underflow:
		CPI	R18, 0XFF
		BREQ CARGAR_VALOR
		RET
CARGAR_VALOR:
		LDI	R18, 0X0F
		RET



SUMAR2:
		SBRS	R16, 2 
		SWAP	R17    
		INC		R17
		CALL	EVITAR_CARRY2
		SWAP	R17
		ADD		R20, R17
		OUT		PORTB, R20
		RET
EVITAR_CARRY2:
		CPI R17, 0X10
		BREQ LIMPIAR2
		RET
LIMPIAR2:
		CLR R17
		RET


RESTAR2:
		SBRS	R16, 3   
		SWAP	R17
		DEC		R17
		CALL	EVITAR_UNDERFLOW2
		SWAP	R17
		ADD		R20, R17
		OUT		PORTB,  R20
		RET
EVITAR_UNDERFLOW2:
		CPI		R17, 0XFF
		BREQ	CARGAR_VALOR2
		RET
CARGAR_VALOR2:
		LDI R17,0X0F
		RET


TIEMPO:
	LDI		R20, 0xFF
SUB_DELAY1:
	DEC		R20
	CPI		R20, 0
	BRNE	SUB_DELAY1
	LDI		R20, 0xFF
SUB_DELAY2:
	DEC		R20
	CPI		R20, 0
	BRNE	SUB_DELAY2
	LDI		R20, 0xFF
SUB_DELAY3:
	DEC		R20
	CPI		R20, 0
	BRNE	SUB_DELAY3
	LDI		R20, 0xFF
SUB_DELAY4:
	DEC		R20
	CPI		R20, 0
	BRNE	SUB_DELAY4
	LDI		R20, 0xFF
SUB_DELAY5:
	DEC		R20
	CPI		R20, 0
	BRNE	SUB_DELAY5
	RET